<!--
==============================================================================
PATIENT MANAGEMENT DASHBOARD
==============================================================================
Purpose: Main dashboard with patient records, data visualizations, and CRUD operations
Features: Interactive charts, role-based actions, responsive data table
==============================================================================
-->

<!DOCTYPE html>
<html>
<head>
    <title>Patients List</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(to bottom right, #f0f2f5, #ffffff);
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .audit-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: rgba(88, 86, 214, 0.1);
            color: #5856D6;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .audit-button:hover {
            background: rgba(88, 86, 214, 0.2);
            transform: translateY(-1px);
        }

        .role-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
        }

        .role-badge.doctor { background: rgba(44, 124, 230, 0.1); color: #2C7CE6; }
        .role-badge.nurse { background: rgba(230, 87, 79, 0.1); color: #E6574F; }
        .role-badge.admin { background: rgba(75, 174, 79, 0.1); color: #4BAE4F; }

        .patients-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .actions { margin-bottom: 2rem; }

        .button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .button.primary {
            background: #007AFF;
            color: white;
        }

        .button.primary:hover {
            background: #0066CC;
            transform: translateY(-1px);
        }

        /* Gender Chart Styles */
        .gender-chart, .age-chart {
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .gender-chart h3, .age-chart h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .gender-bars {
            width: var(--bar-width);
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .gender-bars .bar {
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 6px;
            padding: 0.3rem 0.5rem;
            transition: width 0.4s ease;
        }

        .gender-bars .bar.male { background-color: #2C7CE6; }
        .gender-bars .bar.female { background-color: #E6574F; }
        .gender-bars .bar.other { background-color: #86868b; }

        /* Age Chart Styles */
        .age-bars {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .age-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .age-bar .label {
            width: 3rem;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .age-bar .bar-bg {
            flex: 1;
            height: 8px;
            background: #f0f0f5;
            border-radius: 6px;
            overflow: hidden;
        }

        .age-bar .bar-fill {
            height: 100%;
            background: linear-gradient(to right, #4BAE4F, #2C7CE6);
            border-radius: 6px;
            transition: width 0.4s ease;
            width: var(--bar-width);
        }

        .age-bar .count {
            min-width: 2rem;
            font-size: 0.85rem;
            text-align: right;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1rem;
        }

        th {
            text-align: left;
            padding: 1rem;
            background: #f5f5f7;
            color: #1d1d1f;
            font-weight: 600;
            font-size: 0.9rem;
        }

        th:first-child { border-top-left-radius: 12px; }
        th:last-child { border-top-right-radius: 12px; }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e5e5e5;
            color: #1d1d1f;
        }

        tr:last-child td { border-bottom: none; }

        .action-link {
            padding: 0.5rem;
            border-radius: 8px;
            color: #007AFF;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .action-link:hover { background: rgba(0, 122, 255, 0.1); }

        .delete-form { display: inline; }
        .delete-button {
            background: none;
            border: none;
            color: #E6574F;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .delete-button:hover { background: rgba(230, 87, 79, 0.1); }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #86868b;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .back-link:hover { background: rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body>
    <div class="header">
        <h1>Patients List</h1>
        <div class="header-controls">
            <div class="role-badge {{ role.lower() }}">
                <i class="fas fa-user-{{ 'md' if role == 'Doctor' else 'nurse' if role == 'Nurse' else 'shield' }}"></i>
                <span>{{ role }}</span>
            </div>
            {% if role == 'Admin' %}
            <a href="{{ url_for('logs', role=role) }}" class="audit-button">
                <i class="fas fa-history"></i>
                View Audit Logs
            </a>
            {% endif %}
        </div>
    </div>

    <div class="patients-container">
        <div class="actions">
            {% if role == 'Doctor' %}
            <a href="{{ url_for('add_patient', role=role) }}" class="button primary">
                <i class="fas fa-plus"></i>
                Add Patient
            </a>
            {% endif %}
        </div>

        <!-- Gender Distribution -->
        {% if gender_data %}
        <div class="gender-chart">
            <h3>Gender Distribution</h3>
            <div class="gender-bars">
        <div class="bar male" style="--bar-width: {{ gender_data.male_percent|default(0) }}%;">
            {{ gender_data.male }} Male
        </div>
        <div class="bar female" style="--bar-width: {{ gender_data.female_percent|default(0) }}%;">
            {{ gender_data.female }} Female
        {% if gender_data.other > 0 %}
        <div class="bar other" style="--bar-width: {{ gender_data.other_percent|default(0) }}%;">
            {{ gender_data.other }} Other
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Age Distribution -->
{% if age_bins %}
<div class="age-chart">
    <h3>Age Distribution</h3>
    <div class="age-bars">
        {% set total = patients|length %}
        {% for label, count in age_bins.items() %}
        <div class="age-bar">
            <span class="label">{{ label }}</span>
            <div class="bar-bg">
                {% if total > 0 %}
                <div class="bar-fill" style="--bar-width: {{ (count / total * 100) | round(2) }}%;"></div>
                {% else %}
                <div class="bar-fill" style="width: 0%"></div>
                {% endif %}
            </div>
            <span class="count">{{ count }}</span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>DOB</th>
                    <th>Gender</th>
                    <th>Diagnosis</th>
                    <th>Treatment</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for patient in patients %}
                <tr>
                    <td>{{ patient.name }}</td>
                    <td>{{ patient.dob }}</td>
                    <td>{{ patient.gender }}</td>
                    <td>{{ patient.diagnosis }}</td>
                    <td>{{ patient.treatment }}</td>
                    <td>
                        {% if role == 'Doctor' %}
                        <a href="{{ url_for('edit_patient', id=patient.id, role=role) }}" class="action-link">
                            <i class="fas fa-edit"></i>
                        </a>
                        <form class="delete-form" action="{{ url_for('delete_patient', id=patient.id) }}" method="POST">
                            <input type="hidden" name="role" value="{{ role }}">
                            <button type="submit" class="delete-button" onclick="return confirm('Are you sure you want to delete this patient?')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                        {% endif %}
                        {% if role == 'Nurse' %}
                        <a href="{{ url_for('edit_treatment', id=patient.id, role=role) }}" class="action-link">
                            <i class="fas fa-prescription"></i>
                        </a>
                        {% endif %}
                        {% if role == 'Admin' %}
                        <a href="{{ url_for('view_encrypted', id=patient.id, role=role) }}" class="action-link">
                            <i class="fas fa-lock"></i>
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div style="margin-top: 2rem;">
        <a href="{{ url_for('index') }}" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Back to Home
        </a>
    </div>
</body>
</html>
